<div *ngIf="loading" class="spinner-container">
  <div class="spinner"></div>
</div>

<h4 *ngIf="error" class="text-danger">The event with the id '{{id}}' could not be found!</h4>

<div *ngIf="!error && !loading" class="h-100 w-100">
  <div class="header-line">
    <h2>Event Details</h2>
    <span>

    <button (click)="edit?saveUpdate():edit=!edit" [ngClass]="edit?'btn-info':'btn-warning'" [title]="edit?'Save':'Edit'"
            [disabled]="edit && eventForm.invalid" class="btn btn-edit text-white"
            type="button">{{edit ? '🖫' : '✎'}}</button>
      <!-- Eventform valid-->
    <button (click)="openDeleteDialogue(content)" [hidden]="edit" class="btn btn-danger text-white m-lg-2" title="Delete" type="button">🗑</button>
    <button (click)="cancel()" [hidden]="!edit" [title]="'Cancel'" class="btn btn-edit text-white m-lg-2 btn-secondary" type="button">🗙</button>
  </span>
  </div>

  <div class="row">
    <div class="col-4 h-100">
      <div class="row m-1">
        <table class=" table table-borderless table-sm">
          <tbody [formGroup]="eventForm">
          <tr>
            <td class="fw-bold">Sequence ID:</td>
            <td class="fw-bold">{{event?.metadata?.event_id}}</td>
          </tr>
          <tr>
            <td class="fw-bold">State:</td>
            <td
              [ngClass]="{'fw-bold': true,
                          'text-success': event?.metadata?.state === statusEnum.CORRECT,
                          'text-warning': event?.metadata?.state === statusEnum.FAULTY,
                          'text-danger':  event?.metadata?.state === statusEnum.MISSING}"

            >{{event?.metadata?.state}}</td>
          </tr>
          <tr>
            <td class="fw-bold">Number of Tags:</td>
            <td class="fw-bold">{{event?.tags?.length}}</td>
          </tr>
          <tr>
            <td class="fw-bold">Last Updated:</td>
            <td class="fw-bold">{{convertDate(event?.metadata?.updated)}}</td>
          </tr>
          <tr>
            <td></td>
            <td>
              <div *ngIf="noChanges" class="text-warning">The values were not changed, therefore no update got sent!</div>
            </td>
          </tr>
          <tr>
            <td></td>
            <td></td>
          </tr>
          <tr>
          <tr>
            <td>Name:</td>
            <td *ngIf="!edit">{{event?.metadata?.name}}</td>
            <td *ngIf="edit"><label><input aria-describedby="inputName" autocomplete="off" class="form-control" formControlName="name" id="inputName"
                                           type="text"></label>
            </td>
          </tr>
          <tr>
            <td>Device Identifier:</td>
            <td *ngIf="!edit">{{event?.metadata?.dev_id}}</td>
            <td *ngIf="edit"><label><input aria-describedby="inputDevId" autocomplete="off" class="form-control" formControlName="device_identifier"
                                           id="inputDevId"
                                           type="text"></label>
            </td>
          </tr>
          <tr>
            <td [ngClass]="{'created-padding-top': edit}">Created:</td>
            <td *ngIf="!edit">{{event?.metadata?.created ? convertDate(event?.metadata?.created) : ''}}</td>
            <td *ngIf="edit" class="d-flex">
              <label class="w-50 d-flex align-items-center">
                <input #d="ngbDatepicker" autocomplete="off" class="form-control w-50 h-25" formControlName="created_date" name="dp" ngbDatepicker
                       placeholder="yyyy-mm-dd">
                <button (click)="d.toggle()" class="btn btn-outline-secondary calendar btn-sm h-25" type="button">📅</button>
              </label>
              <label class="w-50 d-flex">
                <ngb-timepicker [(ngModel)]="createdTime" formControlName="created_time"></ngb-timepicker>
              </label>
            </td>
          </tr>
          <tr>
            <td>Frame:</td>
            <td *ngIf="!edit">{{event?.metadata ? event?.metadata?.frame_num + '/' + event?.metadata?.event_frames : ''}}</td>
            <td *ngIf="edit">
              <div class="d-flex">
                <label><input aria-describedby="inputFrameNum" autocomplete="off" class="form-control w-50 space-right" formControlName="frame_number"
                              id="inputFrameNum"
                              min="1" title="Frame of this specific event" type="number"></label>
                <span>/</span>
                <label><input aria-describedby="inputEventFrames" autocomplete="off" class="form-control w-50 space-left float-end"
                              formControlName="event_frames"
                              id="inputEventFrames"
                              min="1" title="Sum of all frames for this specific event" type="number"></label>
              </div>
            </td>
          </tr>
          <tr>
            <td>Place Identifier:</td>
            <td *ngIf="!edit">{{event?.metadata?.place_ident}}</td>
            <td *ngIf="edit"><label><input aria-describedby="inputPlaceId" autocomplete="off" class="form-control" formControlName="place_identifier"
                                           id="inputPlaceId"
                                           type="text"></label>
          </tr>
          <tr>
            <td>Longitude:</td>
            <td *ngIf="!edit">{{event?.metadata?.longitude}}</td>
            <td *ngIf="edit"><label><input aria-describedby="inputLongitude" autocomplete="off" class="form-control" formControlName="longitude"
                                           id="inputLongitude"
                                           type="text"></label>
          </tr>
          <tr>
            <td>Latitude:</td>
            <td *ngIf="!edit">{{event?.metadata?.latitude}}</td>
            <td *ngIf="edit"><label><input aria-describedby="inputLatitude" autocomplete="off" class="form-control" formControlName="latitude"
                                           id="inputLatitude"
                                           type="text"></label>
          </tr>
          </tbody>
        </table>
        <div *ngIf="eventForm.invalid" class="text-danger line-break">
          {{getFormControlError()}}
        </div>
        <app-event-map [class.map-m-top]="!edit" [showSearchCircle]="false" [singleEvent]="event" class="w-100 p-0"></app-event-map>
      </div>
    </div>
    <div class="col-8">
      <div class="main-img">
        <ngb-carousel #tagCarousel (slid)="activeSliderId = carousel.activeId" [animation]="false" [interval]="0"
                      [showNavigationIndicators]="false" class="register">
          <ng-template *ngFor="let tag of tags" ngbSlide>
            <div class="picsum-img-wrapper text-center">
              <img [src]="'data:image/jpeg;base64,'+tag?.image" alt="{{'Tag number '+findTagIndex(tag)}}">
            </div>
            <div class="carousel-caption">
              <h1 class="no-select">{{tag.tag_name}}</h1>
            </div>
          </ng-template>
        </ngb-carousel>
        <div *ngIf="tags===[]" class="text-warning">No tags available!</div>

        <ul class="carousel-thumbnail">
          <li (click)="goToSlide(tag)" *ngFor="let tag of tags" class="carousel-thumbnail__item list-inline-item">
            <a class="selected">
              <img [ngClass]="{'thumbnail_selected_border': activeSliderId === ('ngb-slide-'+findTagIndex(tag).toString())}"
                   [src]="'data:image/jpeg;base64,'+tag?.image" alt="{{'Tag number '+findTagIndex(tag)}}"
                   class="carousel-thumbnail__img">
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<ng-template #content let-c="close" let-d="dismiss" let-modal>
  <!-- To prevent auto focus -->
  <label><input autocomplete="off" class="d-none" type="text"/></label>
  <div class="modal-header d-flex justify-content-between">
    <h3>Confirmation required</h3>
    <button (click)="d('Cross click')" aria-label="Close" class="close btn btn-default" type="button">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Are you sure that you want to delete this event?
  </div>
  <div class="modal-footer">
    <button (click)="c('Close click')" class="btn btn-secondary" type="button">Close</button>
    <button (click)="c('Close click'); deleteEvent()" class="btn btn-danger" type="button">Delete</button>
  </div>
</ng-template>

<bc-app-toasts aria-atomic="true" aria-live="polite" class="toasty"></bc-app-toasts>
